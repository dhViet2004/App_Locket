{
  "info": {
    "name": "Admin API",
    "description": "Admin endpoints",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:4000",
      "type": "string"
    },
    {
      "key": "token",
      "value": "",
      "type": "string"
    },
    {
      "key": "user_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "post_id",
      "value": "656000000000000000000001",
      "type": "string"
    },
    {
      "key": "conversation_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "other_user_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "audit_log_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "plan_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "refund_id",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "Ban User",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response has success field', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('success');",
              "    pm.expect(jsonData.success).to.be.true;",
              "});",
              "",
              "pm.test('User isActive should be false', function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.data && jsonData.data.user) {",
              "        pm.expect(jsonData.data.user.isActive).to.be.false;",
              "    }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{token}}"
          },
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/admin/users/:userId/ban",
          "host": [
            "{{base_url}}"
          ],
          "path": [
            "api",
            "admin",
            "users",
            ":userId",
            "ban"
          ],
          "variable": [
            {
              "key": "userId",
              "value": "{{user_id}}",
              "description": "ID của user cần ban"
            }
          ]
        },
        "description": "Ban (khóa) tài khoản người dùng. Chỉ Admin/SuperAdmin mới có quyền.\n\n**Yêu cầu:**\n- Header: `Authorization: Bearer <token>` (token của admin)\n- User phải có role `admin` hoặc `superadmin`\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"message\": \"User banned successfully\",\n  \"data\": {\n    \"user\": {\n      \"_id\": \"...\",\n      \"username\": \"...\",\n      \"isActive\": false\n    }\n  }\n}\n```\n\n**Lưu ý:**\n- Hành động này sẽ được ghi vào AdminAuditLog\n- isActive sẽ được set thành false"
      }
    },
    {
      "name": "Unban User",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response has success field', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('success');",
              "    pm.expect(jsonData.success).to.be.true;",
              "});",
              "",
              "pm.test('User isActive should be true', function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.data && jsonData.data.user) {",
              "        pm.expect(jsonData.data.user.isActive).to.be.true;",
              "    }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{token}}"
          },
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/admin/users/:userId/unban",
          "host": [
            "{{base_url}}"
          ],
          "path": [
            "api",
            "admin",
            "users",
            ":userId",
            "unban"
          ],
          "variable": [
            {
              "key": "userId",
              "value": "{{user_id}}",
              "description": "ID của user cần unban"
            }
          ]
        },
        "description": "Unban (mở khóa) tài khoản người dùng. Chỉ Admin/SuperAdmin mới có quyền.\n\n**Yêu cầu:**\n- Header: `Authorization: Bearer <token>` (token của admin)\n- User phải có role `admin` hoặc `superadmin`\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"message\": \"User unbanned successfully\",\n  \"data\": {\n    \"user\": {\n      \"_id\": \"...\",\n      \"username\": \"...\",\n      \"isActive\": true\n    }\n  }\n}\n```\n\n**Lưu ý:**\n- Hành động này sẽ được ghi vào AdminAuditLog với actionType 'UPDATE'\n- isActive sẽ được set thành true"
      }
    },
    {
      "name": "Delete Post",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response has success field', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('success');",
              "    pm.expect(jsonData.success).to.be.true;",
              "});",
              "",
              "pm.test('Post should be deleted', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.data).to.have.property('post');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "DELETE",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/admin/posts/:postId",
          "host": [
            "{{base_url}}"
          ],
          "path": [
            "api",
            "admin",
            "posts",
            ":postId"
          ],
          "variable": [
            {
              "key": "postId",
              "value": "{{post_id}}"
            }
          ]
        },
        "description": "Xóa vĩnh viễn một bài đăng và tất cả comment, reaction liên quan. Chỉ Admin/SuperAdmin mới có quyền.\n\n**Yêu cầu:**\n- Header: `Authorization: Bearer <token>` (token của admin)\n- User phải có role `admin` hoặc `superadmin`\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"message\": \"Post deleted successfully\",\n  \"data\": {\n    \"post\": {\n      \"_id\": \"...\",\n      \"author\": \"...\",\n      \"caption\": \"...\"\n    }\n  }\n}\n```\n\n**Lưu ý:**\n- Hành động này sẽ được ghi vào AdminAuditLog\n- Post, Comment và Reaction liên quan sẽ bị xóa vĩnh viễn"
      }
    },
    {
      "name": "Get Audit Logs",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response has success field', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('success');",
              "    pm.expect(jsonData.success).to.be.true;",
              "});",
              "",
              "pm.test('Response has data with items array', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.data).to.have.property('items');",
              "    pm.expect(jsonData.data.items).to.be.an('array');",
              "});",
              "",
              "pm.test('Audit log items have required fields', function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.data.items && jsonData.data.items.length > 0) {",
              "        var log = jsonData.data.items[0];",
              "        pm.expect(log).to.have.property('adminId');",
              "        pm.expect(log).to.have.property('actionType');",
              "        pm.expect(log).to.have.property('targetResource');",
              "        pm.expect(log).to.have.property('targetId');",
              "        pm.expect(log).to.have.property('details');",
              "        pm.expect(log).to.have.property('createdAt');",
              "        ",
              "        // Auto-save first audit log ID for testing",
              "        if (log._id) {",
              "            pm.collectionVariables.set('audit_log_id', log._id);",
              "        }",
              "    }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/admin/audit-logs?page=1&limit=20&actionType=BAN&targetResource=USER",
          "host": [
            "{{base_url}}"
          ],
          "path": [
            "api",
            "admin",
            "audit-logs"
          ],
          "query": [
            {
              "key": "page",
              "value": "1",
              "description": "Số trang (default: 1)"
            },
            {
              "key": "limit",
              "value": "20",
              "description": "Số lượng items mỗi trang (default: 20, max: 100)"
            },
            {
              "key": "actionType",
              "value": "BAN",
              "description": "Filter theo actionType: CREATE, UPDATE, DELETE, BAN",
              "disabled": true
            },
            {
              "key": "targetResource",
              "value": "USER",
              "description": "Filter theo targetResource: USER, POST, SUBSCRIPTION",
              "disabled": true
            }
          ]
        },
        "description": "Lấy danh sách audit logs của các hành động admin. Chỉ Admin/SuperAdmin mới có quyền.\n\n**Query Parameters:**\n- `page`: Số trang (default: 1)\n- `limit`: Số lượng items mỗi trang (default: 20, max: 100)\n- `actionType`: Filter theo loại hành động (CREATE, UPDATE, DELETE, BAN)\n- `targetResource`: Filter theo loại tài nguyên (USER, POST, SUBSCRIPTION)\n- `targetId`: Filter theo ID của tài nguyên\n- `adminId`: Filter theo ID của admin thực hiện\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"message\": \"ok\",\n  \"data\": {\n    \"items\": [\n      {\n        \"_id\": \"...\",\n        \"adminId\": {\n          \"_id\": \"...\",\n          \"username\": \"admin\",\n          \"displayName\": \"Admin User\"\n        },\n        \"actionType\": \"BAN\",\n        \"targetResource\": \"USER\",\n        \"targetId\": \"652000000000000000000002\",\n        \"details\": {\n          \"description\": \"Ban user ... by admin\",\n          \"before\": { \"isActive\": true },\n          \"after\": { \"isActive\": false }\n        },\n        \"createdAt\": \"2024-01-01T00:00:00.000Z\"\n      }\n    ],\n    \"page\": 1,\n    \"limit\": 20,\n    \"total\": 100\n  }\n}\n```\n\n**Lưu ý:**\n- Kết quả được sắp xếp theo createdAt giảm dần (mới nhất trước)\n- AdminId được populate với thông tin username, displayName, email"
      }
    },
    {
      "name": "Get Audit Log by ID",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response has success field', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('success');",
              "    pm.expect(jsonData.success).to.be.true;",
              "});",
              "",
              "pm.test('Audit log has all required fields', function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.data) {",
              "        var log = jsonData.data;",
              "        pm.expect(log).to.have.property('_id');",
              "        pm.expect(log).to.have.property('adminId');",
              "        pm.expect(log).to.have.property('actionType');",
              "        pm.expect(log).to.have.property('targetResource');",
              "        pm.expect(log).to.have.property('targetId');",
              "        pm.expect(log).to.have.property('details');",
              "        pm.expect(log).to.have.property('createdAt');",
              "    }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/admin/audit-logs/:id",
          "host": [
            "{{base_url}}"
          ],
          "path": [
            "api",
            "admin",
            "audit-logs",
            ":id"
          ],
          "variable": [
            {
              "key": "id",
              "value": "{{audit_log_id}}",
              "description": "ID của audit log (có thể lấy từ Get Audit Logs response)"
            }
          ]
        },
        "description": "Lấy thông tin chi tiết của một audit log theo ID. Chỉ Admin/SuperAdmin mới có quyền.\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"message\": \"ok\",\n  \"data\": {\n    \"_id\": \"...\",\n    \"adminId\": \"...\",\n    \"actionType\": \"BAN\",\n    \"targetResource\": \"USER\",\n    \"targetId\": \"652000000000000000000002\",\n    \"details\": {},\n    \"createdAt\": \"2024-01-01T00:00:00.000Z\"\n  }\n}\n```"
      }
    },
    {
      "name": "Create Plan",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 201', function () {",
              "    pm.response.to.have.status(201);",
              "});",
              "",
              "pm.test('Response has success field', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('success');",
              "    pm.expect(jsonData.success).to.be.true;",
              "});",
              "",
              "pm.test('Plan has all required fields', function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.data && jsonData.data.plan) {",
              "        var plan = jsonData.data.plan;",
              "        pm.expect(plan).to.have.property('_id');",
              "        pm.expect(plan).to.have.property('code');",
              "        pm.expect(plan).to.have.property('name');",
              "        pm.expect(plan).to.have.property('price');",
              "        ",
              "        // Auto-save plan ID for testing",
              "        if (plan._id) {",
              "            pm.collectionVariables.set('plan_id', plan._id);",
              "        }",
              "    }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{token}}"
          },
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"code\": \"premium_monthly\",\n  \"name\": \"Premium Monthly\",\n  \"description\": \"Gói Premium hàng tháng với đầy đủ tính năng\",\n  \"price\": 99000,\n  \"currency\": \"VND\",\n  \"interval\": \"month\",\n  \"intervalCount\": 1,\n  \"trialDays\": 7,\n  \"features\": {\n    \"maxPosts\": 1000,\n    \"adFree\": true,\n    \"prioritySupport\": true\n  },\n  \"isActive\": true\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/admin/plans",
          "host": ["{{base_url}}"],
          "path": ["api", "admin", "plans"]
        },
        "description": "Tạo Plan mới. Chỉ Admin/SuperAdmin mới có quyền.\n\n**Body Parameters:**\n- `code` (required, string): Mã gói nội bộ, phải unique\n- `name` (required, string): Tên gói\n- `description` (optional, string): Mô tả gói\n- `price` (required, number): Giá gói\n- `currency` (optional, string): Đơn vị tiền tệ (default: 'VND')\n- `interval` (required, string): Chu kỳ thanh toán - 'day', 'week', 'month', 'year'\n- `intervalCount` (optional, number): Số chu kỳ (default: 1)\n- `trialDays` (optional, number): Số ngày dùng thử (default: 0)\n- `features` (optional, object): Cấu hình tính năng\n- `isActive` (optional, boolean): Trạng thái hoạt động (default: true)\n\n**Lưu ý:**\n- Hành động này sẽ được ghi vào AdminAuditLog\n- Code phải unique, nếu trùng sẽ trả về lỗi 400\n- Plan ID sẽ được tự động lưu vào collection variable `plan_id`"
      }
    },
    {
      "name": "Update Plan",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response has success field', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('success');",
              "    pm.expect(jsonData.success).to.be.true;",
              "});",
              "",
              "pm.test('Plan has been updated', function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.data && jsonData.data.plan) {",
              "        pm.expect(jsonData.data.plan).to.have.property('_id');",
              "        pm.expect(jsonData.data.plan).to.have.property('code');",
              "        pm.expect(jsonData.data.plan).to.have.property('name');",
              "    }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{token}}"
          },
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"name\": \"Premium Monthly Updated\",\n  \"description\": \"Gói Premium hàng tháng đã được cập nhật\",\n  \"price\": 129000,\n  \"features\": {\n    \"maxPosts\": 2000,\n    \"adFree\": true,\n    \"prioritySupport\": true\n  }\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/admin/plans/:planId",
          "host": ["{{base_url}}"],
          "path": ["api", "admin", "plans", ":planId"],
          "variable": [
            {
              "key": "planId",
              "value": "{{plan_id}}",
              "description": "ID của plan cần cập nhật"
            }
          ]
        },
        "description": "Cập nhật Plan. Chỉ Admin/SuperAdmin mới có quyền.\n\n**Yêu cầu:**\n- Header: `Authorization: Bearer <token>` (token của admin)\n- User phải có role `admin` hoặc `superadmin`\n\n**Body Parameters (tất cả đều optional):**\n- `code` (optional, string): Mã gói nội bộ (phải unique nếu thay đổi)\n- `name` (optional, string): Tên gói\n- `description` (optional, string): Mô tả gói\n- `price` (optional, number): Giá gói\n- `currency` (optional, string): Đơn vị tiền tệ\n- `interval` (optional, string): Chu kỳ thanh toán - 'day', 'week', 'month', 'year'\n- `intervalCount` (optional, number): Số chu kỳ\n- `trialDays` (optional, number): Số ngày dùng thử\n- `features` (optional, object): Cấu hình tính năng\n- `isActive` (optional, boolean): Trạng thái hoạt động\n- `providerMetadata` (optional, object): Metadata payment provider\n\n**Response (200 OK):**\n```json\n{\n  \"success\": true,\n  \"message\": \"Plan updated successfully\",\n  \"data\": {\n    \"plan\": {\n      \"_id\": \"...\",\n      \"code\": \"premium_monthly\",\n      \"name\": \"Premium Monthly Updated\",\n      \"price\": 129000,\n      ...\n    }\n  }\n}\n```\n\n**Lưu ý:**\n- Hành động này sẽ được ghi vào AdminAuditLog với actionType 'UPDATE' và targetResource 'PLAN'\n- Tất cả các trường đều optional - chỉ cập nhật các trường được gửi\n- Nếu code thay đổi, phải unique (không trùng với plan khác)\n- Chỉ các trường được gửi mới được cập nhật, các trường khác giữ nguyên"
      }
    },
    {
      "name": "Deactivate Plan",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response has success field', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('success');",
              "    pm.expect(jsonData.success).to.be.true;",
              "});",
              "",
              "pm.test('Plan has been deactivated', function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.data && jsonData.data.plan) {",
              "        pm.expect(jsonData.data.plan.isActive).to.be.false;",
              "    }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "DELETE",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/admin/plans/:planId",
          "host": ["{{base_url}}"],
          "path": ["api", "admin", "plans", ":planId"],
          "variable": [
            {
              "key": "planId",
              "value": "{{plan_id}}",
              "description": "ID của plan cần vô hiệu hóa"
            }
          ]
        },
        "description": "Vô hiệu hóa Plan (soft delete - set isActive: false). Chỉ Admin/SuperAdmin mới có quyền.\n\n**Yêu cầu:**\n- Header: `Authorization: Bearer <token>` (token của admin)\n- User phải có role `admin` hoặc `superadmin`\n\n**Response (200 OK):**\n```json\n{\n  \"success\": true,\n  \"message\": \"Plan deactivated successfully\",\n  \"data\": {\n    \"plan\": {\n      \"_id\": \"...\",\n      \"code\": \"premium_monthly\",\n      \"name\": \"Premium Monthly\",\n      \"isActive\": false,\n      ...\n    }\n  }\n}\n```\n\n**Lưu ý:**\n- Hành động này sẽ được ghi vào AdminAuditLog với actionType 'UPDATE' và targetResource 'PLAN'\n- Plan không bị xóa khỏi database, chỉ set `isActive: false`\n- Plan vô hiệu hóa sẽ không xuất hiện trong danh sách public plans\n- Các subscription hiện tại sử dụng plan này vẫn hoạt động bình thường\n- Đây là soft delete, có thể kích hoạt lại bằng API Activate Plan"
      }
    },
    {
      "name": "Activate Plan",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response has success field', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('success');",
              "    pm.expect(jsonData.success).to.be.true;",
              "});",
              "",
              "pm.test('Plan has been activated', function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.data && jsonData.data.plan) {",
              "        pm.expect(jsonData.data.plan.isActive).to.be.true;",
              "    }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/admin/plans/:planId/activate",
          "host": ["{{base_url}}"],
          "path": ["api", "admin", "plans", ":planId", "activate"],
          "variable": [
            {
              "key": "planId",
              "value": "{{plan_id}}",
              "description": "ID của plan cần kích hoạt"
            }
          ]
        },
        "description": "Kích hoạt lại Plan (set isActive: true). Chỉ Admin/SuperAdmin mới có quyền.\n\n**Yêu cầu:**\n- Header: `Authorization: Bearer <token>` (token của admin)\n- User phải có role `admin` hoặc `superadmin`\n\n**Response (200 OK):**\n```json\n{\n  \"success\": true,\n  \"message\": \"Plan activated successfully\",\n  \"data\": {\n    \"plan\": {\n      \"_id\": \"...\",\n      \"code\": \"premium_monthly\",\n      \"name\": \"Premium Monthly\",\n      \"isActive\": true,\n      ...\n    }\n  }\n}\n```\n\n**Lưu ý:**\n- Hành động này sẽ được ghi vào AdminAuditLog với actionType 'UPDATE' và targetResource 'PLAN'\n- Plan sẽ được set `isActive: true`\n- Plan đã kích hoạt sẽ xuất hiện trong danh sách public plans\n- Dùng để khôi phục plan sau khi đã deactivate\n- Ngoài ra, có thể dùng Update Plan API với `isActive: true` để kích hoạt lại"
      }
    },
    {
      "name": "Process Refund",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response has success field', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('success');",
              "    pm.expect(jsonData.success).to.be.true;",
              "});",
              "",
              "pm.test('Refund has been processed', function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.data && jsonData.data.refund) {",
              "        var refund = jsonData.data.refund;",
              "        pm.expect(refund).to.have.property('status');",
              "        pm.expect(['APPROVED', 'REJECTED']).to.include(refund.status);",
              "        pm.expect(refund).to.have.property('processedByAdminId');",
              "        ",
              "        // If approved, should have refundedAt",
              "        if (refund.status === 'APPROVED') {",
              "            pm.expect(refund).to.have.property('refundedAt');",
              "        }",
              "    }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{token}}"
          },
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"status\": \"APPROVED\",\n  \"adminNote\": \"Đã xác nhận và hoàn tiền thành công\",\n  \"externalRefundId\": \"ref_123456789\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/admin/refunds/:refundId/process",
          "host": ["{{base_url}}"],
          "path": ["api", "admin", "refunds", ":refundId", "process"],
          "variable": [
            {
              "key": "refundId",
              "value": "{{refund_id}}",
              "description": "ID của refund cần xử lý"
            }
          ]
        },
        "description": "Xử lý refund: phê duyệt (APPROVED) hoặc từ chối (REJECTED). Chỉ Admin/SuperAdmin mới có quyền.\n\n**Body Parameters:**\n- `status` (required, string): 'APPROVED' hoặc 'REJECTED'\n- `adminNote` (optional, string): Ghi chú của Admin\n- `externalRefundId` (optional, string): ID refund từ payment provider\n\n**Khi APPROVED:**\n- Refund status = 'APPROVED'\n- Subscription sẽ bị hủy (status = 'canceled')\n- Revenue snapshot được cập nhật\n- Audit log được ghi lại\n\n**Khi REJECTED:**\n- Refund status = 'REJECTED'\n- Subscription không bị ảnh hưởng\n- Audit log được ghi lại"
      }
    },
    {
      "name": "Test Unauthorized Access (403)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 403', function () {",
              "    pm.response.to.have.status(403);",
              "});",
              "",
              "pm.test('Response has error message', function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('message');",
              "    pm.expect(jsonData.message).to.include('Access Denied');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "PUT",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/admin/users/:userId/ban",
          "host": [
            "{{base_url}}"
          ],
          "path": [
            "api",
            "admin",
            "users",
            ":userId",
            "ban"
          ],
          "variable": [
            {
              "key": "userId",
              "value": "{{user_id}}",
              "description": "ID của user để test"
            }
          ]
        },
        "description": "Test case để verify middleware phân quyền. Nếu user không có role admin/superadmin, sẽ nhận 403.\n\n**Expected Response:**\n```json\n{\n  \"statusCode\": 403,\n  \"message\": \"Access Denied: Insufficient permissions\"\n}\n```"
      }
    }
  ]
}